# Iteration 12.6: Fix Delete Action Matching for Shim Generation
> **Context**: See `current_plan/00_overview.md` for overall strategy and principles.
> **Prerequisites**: Iteration 12.5 must be completed first.

## Overview

After fixing module name derivation in iteration 12.5, one test still fails: `test_affects_shims_only_affects_shim_generation`. The issue is that delete actions with `affects: "shims"` cannot properly match shim names when the action source appears as a component in the shim path (e.g., source `"pkg1"` vs shim `"mypkg.pkg1"`).

## Failing Test

### Test: `test_affects_shims_only_affects_shim_generation`
**Location**: `tests/9_integration/test_module_actions_integration.py:271`

**Test Setup**:
- Files: `pkg1/__init__.py`, `pkg1/module.py`
- `package="mypkg"`, `module_mode="multi"` (default)
- User action: `{"source": "pkg1", "action": "delete", "affects": "shims"}`

**Expected Behavior**:
- Action deletes `pkg1` from shim generation only (files still stitched)
- File should still be stitched (module code should be present)
- Shim for `pkg1` should be deleted (no shim should exist for `pkg1` or `mypkg.pkg1`)

**Actual Error**:
```
assert '"pkg1"' not in normalized or '"mypkg.pkg1"' not in normalized
Failed: Both '"pkg1"' and '"mypkg.pkg1"' are present in output
```

**Observed Output**:
- `_setup_pkg_modules("pkg1", ["pkg1.module"])` - shim for `pkg1` exists
- `_setup_pkg_modules("mypkg", ["mypkg.pkg1"])` - shim for `mypkg.pkg1` exists
- Both shims are present, indicating the delete action didn't match either

## Root Cause Analysis

### Current State After Iteration 12.5

After fixing module name derivation:
- `_original_order_names_for_shims = ["pkg1", "pkg1.module"]` (correctly includes package name)
- After prepending `package_name`: shim names become `["mypkg.pkg1", "mypkg.pkg1.module"]`
- Delete action source is `"pkg1"`

### The Problem

1. **Delete Action Matching Logic** (`src/serger/module_actions.py:519-554`):
   - Current logic checks:
     - Exact match: `module_name == source` → `"mypkg.pkg1" != "pkg1"` ❌
     - Prefix match: `module_name.startswith(f"{source}.")` → `"mypkg.pkg1"` doesn't start with `"pkg1."` ❌
   - **Partially fixed**: Added component check `source in module_name.split(".")`, but test still fails

2. **Shim Name Generation**:
   - After prepending `package_name`, shim names are `["mypkg.pkg1", "mypkg.pkg1.module"]`
   - But output shows both `"pkg1"` and `"mypkg.pkg1"` exist
   - This suggests either:
     - Multiple shim entries are being created (one for original name, one for full path)
     - Delete action is not being applied at the right point
     - Delete action is being applied but something else recreates the shims

3. **Action Application Point**:
   - Delete action with `affects: "shims"` is applied in `_build_final_script()` at shim scope
   - Applied after prepending `package_name` to create full paths
   - But the output shows `"pkg1"` as a separate shim, suggesting it might be created elsewhere

### Investigation Needed

1. **Check shim generation logic**: Are shims being generated from multiple sources?
   - `_original_order_names_for_shims` → `["pkg1", "pkg1.module"]`
   - After prepending: `["mypkg.pkg1", "mypkg.pkg1.module"]`
   - But output shows `"pkg1"` as a separate entry

2. **Check delete action application**: Is the delete action being applied correctly?
   - Action source: `"pkg1"`
   - Shim names before delete: `["mypkg.pkg1", "mypkg.pkg1.module"]`
   - Component check: `"pkg1" in "mypkg.pkg1".split(".")` → should be `True`
   - But shims still exist in output

3. **Check shim generation after actions**: Are shims being regenerated after delete?
   - Shim generation happens in `_build_final_script()`
   - Delete action is applied to `shim_names` list
   - But shims might be generated from a different source

## Proposed Solutions

### Solution 1: Verify Delete Action Matching Logic

**Problem**: Component matching might not be working correctly.

**Approach**: Verify that the component check in `_apply_delete_action()` is correct and being executed.

**Implementation**:

1. **Verify current implementation** (`src/serger/module_actions.py:546-550`):
   ```python
   # Check if source appears as a component in module_name
   if source in module_name.split("."):
       # Source is a component: delete it
       continue
   ```

2. **Add debug logging** to verify matching:
   ```python
   logger.debug("Delete action: source=%s, module_name=%s, components=%s, match=%s",
                source, module_name, module_name.split("."),
                source in module_name.split("."))
   ```

3. **Test**: Run test with debug logging to see if matching is working

**Expected Result**:
- Component check should match `"pkg1"` in `"mypkg.pkg1"`
- Delete action should remove matching shims

### Solution 2: Check for Multiple Shim Generation Sources

**Problem**: Shims might be generated from multiple sources, creating duplicate entries.

**Approach**: Investigate if shims are being generated from both `order_names` and `_original_order_names_for_shims`, or if there's another code path creating shims.

**Implementation**:

1. **Check shim generation** (`src/serger/stitch.py:1811-1944`):
   - Verify that only one source is used for shim generation
   - Check if `order_names` is also being used when `_original_order_names_for_shims` is available

2. **Check for duplicate shim creation**:
   - Look for multiple calls to shim generation functions
   - Check if shims are created from both original and transformed names

3. **Add debug logging**:
   ```python
   logger.debug("Shim generation: using _original_order_names_for_shims=%s, order_names=%s",
                _original_order_names_for_shims is not None, order_names)
   logger.debug("Shim names before delete: %s", shim_names)
   ```

**Expected Result**:
- Only one set of shim names should be generated
- No duplicate entries for the same module

### Solution 3: Verify Delete Action Application Timing

**Problem**: Delete action might be applied too early or too late in the pipeline.

**Approach**: Verify that delete action is applied at the correct point, after all shim names are generated but before shim code is generated.

**Implementation**:

1. **Check action application order** (`src/serger/stitch.py:1937-1944`):
   - Delete action is applied to `shim_names` after prepending `package_name`
   - This should be the correct point, but verify no other code regenerates shims

2. **Check if shims are regenerated**:
   - Look for code that might regenerate shims after delete action
   - Check if shim generation happens in multiple places

3. **Add debug logging**:
   ```python
   logger.debug("Shim names before delete action: %s", shim_names)
   shim_names = apply_single_action(shim_names, action, detected_packages)
   logger.debug("Shim names after delete action: %s", shim_names)
   ```

**Expected Result**:
- Delete action should remove matching shims from `shim_names`
- No code should regenerate shims after delete action

### Solution 4: Handle Package Name in Delete Action Source

**Problem**: Delete action source might need to match against both original and full paths.

**Approach**: When delete action source is a package name, check if it matches both the original name and the full path after prepending.

**Implementation**:

1. **Enhance delete action matching** to handle both cases:
   ```python
   # Check exact match
   if module_name == source:
       continue
   # Check prefix match (for submodules)
   if module_name.startswith(f"{source}."):
       continue
   # Check component match (for full paths)
   if source in module_name.split("."):
       continue
   # Check if source matches after removing package_name prefix
   # (e.g., "pkg1" matches "mypkg.pkg1" after removing "mypkg.")
   if module_name.startswith(f"{package_name}."):
       suffix = module_name[len(package_name) + 1:]
       if suffix == source or suffix.startswith(f"{source}."):
           continue
   ```

2. **Note**: This might be redundant if component check is working, but provides additional safety

**Expected Result**:
- Delete action should match shims regardless of whether they have package prefix or not

## Implementation Strategy

### Recommended Order

1. **Start with Solution 1** (verify delete action matching) - Confirm the matching logic is working
2. **Add Solution 2** (check for multiple sources) - Ensure shims aren't duplicated
3. **Add Solution 3** (verify timing) - Ensure delete action is applied correctly
4. **Add Solution 4** (enhance matching) - If needed, add additional matching logic

### Testing Strategy

After each solution:
1. Run the specific failing test to verify progress
2. Add debug logging to understand what's happening
3. Check the actual output to see what shims are being generated
4. Verify that delete action is matching and removing shims correctly

### Verification Steps

1. **Verify shim names before delete**:
   - Should be `["mypkg.pkg1", "mypkg.pkg1.module"]` (after prepending)
   - Should NOT include `"pkg1"` as a separate entry

2. **Verify delete action matching**:
   - Source `"pkg1"` should match `"mypkg.pkg1"` via component check
   - Source `"pkg1"` should match `"mypkg.pkg1.module"` via component check

3. **Verify shim names after delete**:
   - Should be empty list `[]` (all shims deleted)
   - Should NOT include `"pkg1"` or `"mypkg.pkg1"`

4. **Verify final output**:
   - Should NOT contain `"pkg1"` or `"mypkg.pkg1"` in shim setup code
   - Should still contain module code (`"def func()"`)

## Context for Independent Problem Solving

### Key Files

- `src/serger/stitch.py:1811-1944` - Shim generation and action application
- `src/serger/module_actions.py:519-554` - `_apply_delete_action()` function
- `src/serger/module_actions.py:56-79` - `validate_action_source_exists()` function
- `src/serger/stitch.py:1838-1846` - Action separation by affects value

### Key Concepts

- Delete actions with `affects: "shims"` are applied to shim names after prepending `package_name`
- Action source is original module name (e.g., `"pkg1"`)
- Shim names are full paths after prepending (e.g., `"mypkg.pkg1"`)
- Delete action matching needs to handle source as component in shim path
- Delete actions should skip source validation (they match flexibly)

### Debugging Tips

1. **Add logging in `_apply_delete_action()`**:
   ```python
   logger.debug("Delete action: source=%s, module_name=%s, components=%s, match=%s",
                source, module_name, module_name.split("."),
                source in module_name.split("."))
   ```

2. **Add logging in shim generation**:
   ```python
   logger.debug("Shim names before delete: %s", shim_names)
   shim_names = apply_single_action(shim_names, action, detected_packages)
   logger.debug("Shim names after delete: %s", shim_names)
   ```

3. **Check actual output**:
   - Search for `"pkg1"` and `"mypkg.pkg1"` in stitched output
   - Verify which shim setup functions are being called
   - Check if multiple shim entries exist for the same module

## Related Code Sections

### Delete Action Implementation
```python
# src/serger/module_actions.py:519-554
def _apply_delete_action(
    module_names: list[str],
    action: "ModuleActionFull",
) -> list[str]:
    source = action["source"]
    result: list[str] = []
    for module_name in module_names:
        if module_name == source:
            continue
        if module_name.startswith(f"{source}."):
            continue
        # Check if source appears as a component
        if source in module_name.split("."):
            continue
        result.append(module_name)
    return result
```

### Shim Scope Action Application
```python
# src/serger/stitch.py:1937-1944
if shim_scope_actions:
    for action in shim_scope_actions:
        action_type = action.get("action", "move")
        if action_type != "delete":
            validate_action_source_exists(action, set(shim_names), scope="shim")
        shim_names = apply_single_action(shim_names, action, detected_packages)
```

## Success Criteria

The test must pass:
1. ✅ `test_affects_shims_only_affects_shim_generation` - Delete action removes shims correctly

Additionally:
- ✅ All other tests continue to pass (no regressions)
- ✅ `poetry run poe check:fix` passes completely
- ✅ No duplicate shim entries in output
- ✅ Files are still stitched (module code present)

## Commit Message

```
fix(module_actions): improve delete action matching for shim paths

- Enhance delete action to match source as component in shim paths
- Fix matching when action source appears in full shim path (e.g., "pkg1" in "mypkg.pkg1")
- Ensure delete actions with affects: "shims" correctly remove shims
- Skip source validation for delete actions (they match flexibly)

Fixes test_affects_shims_only_affects_shim_generation
```

## Next Steps After Fixing

1. Run `poetry run poe check:fix` to verify all tests pass
2. Update `current_plan/START_HERE.md` to mark iteration 12.6 as completed
3. Document any edge cases discovered during fixing
4. Verify that delete actions work correctly for all scenarios

