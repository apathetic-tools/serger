# Iteration 14.6: Fix Remaining Integration Test Failures
> **Context**: See `current_plan/00_overview.md` for overall strategy and principles.
> **Prerequisites**: Iteration 14.5 must be completed first.

## Overview

Iteration 14.5 fixed 7 out of 10 failing integration tests. This iteration addresses the remaining 3 test failures:
1. Header update not working for module section headers
2. Shim scope validation failing after unify mode
3. Delete action shim removal not working with `affects: "shims"`

## Failing Tests Analysis

### Test 1: `test_mode_none_with_user_actions_original_scope`

**Location**: `tests/9_integration/test_module_actions_integration.py:872`

**Test Setup**:
- Files: `oldpkg/__init__.py`, `oldpkg/module.py`
- `package="mypkg"`, `module_mode="none"`
- User action: `{"source": "oldpkg", "dest": "newpkg", "scope": "original"}`

**Expected Behavior**:
- Action transforms `oldpkg` → `newpkg` in module names
- Module section headers should show `"# === newpkg ==="` and `"# === newpkg.module ==="`
- Output should contain `"mypkg.newpkg.module"` or `"newpkg.module"`

**Actual Error**:
```
assert ('"mypkg.newpkg.module"' in ... or '"newpkg.module"' in ...)
Failed: Headers still show "# === oldpkg ===" and "# === oldpkg.module ==="
```

**Root Cause**:
- Header update logic in `src/serger/stitch.py:1908-1930` is not working correctly
- Headers are built from `order_names` in `collect_module_sources()`
- Actions are applied to `shim_names_raw` to get `transformed_names`
- Header update tries to map `order_names` → `transformed_names`, but the mapping isn't working
- The replacement logic may not be finding the headers correctly, or the mapping is incorrect

**Investigation Needed**:
1. Verify that `order_names` and `shim_names_raw` match (they should after iteration 14.5 fixes)
2. Verify that `transformed_order_names` contains the correct transformed names
3. Check if header pattern matching is working correctly
4. Verify that `parts` list is being modified correctly

### Test 2: `test_mode_unify_with_user_actions`

**Location**: `tests/9_integration/test_module_actions_integration.py:840`

**Test Setup**:
- Files: `pkg1/__init__.py`, `pkg1/module.py`
- `package="mypkg"`, `module_mode="unify"`
- User action: `{"source": "mypkg.module", "dest": "mypkg.unified", "scope": "shim"}`

**Expected Behavior**:
- Unify mode transforms multiple packages into one (`pkg1` → `mypkg`)
- After unify, module should be available as `mypkg.module` (or similar)
- User action with `scope: "shim"` should transform `mypkg.module` → `mypkg.unified`

**Actual Error**:
```
ValueError: Module action source 'mypkg.module' does not exist in available modules (scope: 'shim')
```

**Root Cause**:
- Unify mode transforms packages, but the resulting module names may not match what the user action expects
- After unify mode, `pkg1.module` becomes `mypkg.module` (or possibly just `mypkg` if it's the only module)
- The user action expects `mypkg.module` to exist, but it might be named differently
- Shim scope validation happens after prepending `package_name`, so it checks against `shim_names` which are full paths
- The validation is too strict - it should check what module names actually exist after unify mode

**Investigation Needed**:
1. Check what module names exist after unify mode is applied
2. Verify that unify mode correctly transforms `pkg1.module` → `mypkg.module`
3. Check if the user action source should be adjusted to match actual module names
4. Consider if validation should be more flexible for shim scope actions after mode transformations

### Test 3: `test_affects_shims_only_affects_shim_generation_comprehensive`

**Location**: `tests/9_integration/test_module_actions_integration.py:1110`

**Test Setup**:
- Files: `pkg1/__init__.py`, `pkg1/module.py`
- `package="mypkg"`, `module_mode="multi"` (default)
- User action: `{"source": "pkg1", "action": "delete", "affects": "shims"}`

**Expected Behavior**:
- Action deletes `pkg1` from shim generation only (files still stitched)
- File should still be stitched (module code should be present)
- Shim for `pkg1` should be deleted (no shim should exist for `pkg1` or `mypkg.pkg1`)
- Output should NOT contain `"mypkg.pkg1"` in shim setup code

**Actual Error**:
```
assert '"mypkg.pkg1"' not in normalized
Failed: '"mypkg.pkg1"' is contained in output:
  _setup_pkg_modules("mypkg", ["mypkg.pkg1"])
  _setup_pkg_modules("mypkg.pkg1", ["mypkg.pkg1.module"])
```

**Root Cause**:
- Delete action with `affects: "shims"` should be applied to `shim_names` after prepending `package_name`
- Action source is `"pkg1"`, but shim names are `["mypkg.pkg1", "mypkg.pkg1.module"]` after prepending
- Delete action matching logic in `_apply_delete_action()` needs to match `"pkg1"` against `"mypkg.pkg1"`
- The component matching logic (`source in module_name.split(".")`) should work, but may not be applied correctly
- Or the delete action may not be applied at the right point in the pipeline

**Investigation Needed**:
1. Verify that delete action with `affects: "shims"` is being applied to `shim_names`
2. Check if the component matching logic in `_apply_delete_action()` is working correctly
3. Verify that `"pkg1" in "mypkg.pkg1".split(".")` evaluates to `True`
4. Check if the delete action is being applied before or after shim code generation
5. Verify that shims are not being regenerated after the delete action

## Root Cause Analysis

### Issue 1: Header Update Logic Not Working

**Location**: `src/serger/stitch.py:1908-1930`

**Problem**:
- Headers are built in `collect_module_sources()` using `order_names` (derived from file paths)
- Actions are applied to `shim_names_raw` to get `transformed_names`
- Header update tries to apply actions to `order_names` to get `transformed_order_names`
- Then tries to map `order_names[i]` → `transformed_order_names[i]` and update headers
- But the replacement isn't working - headers still show original names

**Possible Causes**:
1. `order_names` and `shim_names_raw` don't match (different order or content)
2. `transformed_order_names` doesn't contain the expected transformed names
3. Header pattern matching isn't finding the headers correctly
4. String replacement isn't working (maybe headers are in a different format)
5. The `parts` list modification isn't being persisted

**Investigation Steps**:
1. Add debug logging to see what `order_names`, `shim_names_raw`, and `transformed_order_names` contain
2. Check if header pattern `"# === oldpkg ==="` actually exists in `parts`
3. Verify that `parts[j].replace(header_pattern, new_header)` is actually modifying the string
4. Check if the modified `parts` list is being used when building the final script

### Issue 2: Shim Scope Validation After Unify Mode

**Location**: `src/serger/stitch.py:1992` (validate_action_source_exists)

**Problem**:
- Unify mode transforms packages (e.g., `pkg1` → `mypkg`)
- After unify, module names change (e.g., `pkg1.module` → `mypkg.module` or just `mypkg`)
- User action with `scope: "shim"` expects `mypkg.module` to exist
- But validation fails because `mypkg.module` doesn't exist in `shim_names`
- This suggests that after unify mode, the module might be named differently

**Possible Causes**:
1. Unify mode doesn't create `mypkg.module` - it might create just `mypkg` or a different name
2. The user action source is incorrect - it should match what unify mode actually creates
3. Validation is happening before unify mode actions are fully applied
4. The module name after unify depends on the structure (single module vs multiple modules)

**Investigation Steps**:
1. Check what module names exist after unify mode is applied
2. Add debug logging to see what `shim_names` contains after unify mode
3. Verify that unify mode correctly transforms the module structure
4. Check if the test expectation is correct - maybe the action source should be different

### Issue 3: Delete Action Shim Removal Not Working

**Location**: `src/serger/module_actions.py:519-554` (`_apply_delete_action`)

**Problem**:
- Delete action with `affects: "shims"` should remove shims from `shim_names`
- Action source is `"pkg1"`, shim names are `["mypkg.pkg1", "mypkg.pkg1.module"]`
- Component matching should work: `"pkg1" in "mypkg.pkg1".split(".")` → `True`
- But shims are still present in the output

**Possible Causes**:
1. Delete action isn't being applied to `shim_names` at all
2. Component matching logic isn't working correctly
3. Delete action is applied but shims are regenerated later
4. The delete action is applied to the wrong list (maybe before prepending `package_name`)

**Investigation Steps**:
1. Add debug logging in `_apply_delete_action()` to see if it's being called
2. Check if component matching is working: `"pkg1" in "mypkg.pkg1".split(".")`
3. Verify that delete action with `affects: "shims"` is in the `shims_only_actions` list
4. Check where `shims_only_actions` are applied in the pipeline
5. Verify that shims aren't being regenerated after the delete action

## Proposed Solutions

### Solution 1: Fix Header Update Logic

**Approach**: Ensure header update correctly maps and replaces module names in headers.

**Implementation**:

1. **Verify mapping correctness**:
   - Ensure `order_names` and `shim_names_raw` match (they should after iteration 14.5)
   - Apply actions to `order_names` to get `transformed_order_names`
   - Verify that `transformed_order_names` contains the expected transformed names

2. **Fix header replacement**:
   - Use more robust pattern matching (maybe regex)
   - Ensure replacement actually modifies the `parts` list
   - Verify that modified `parts` are used when building final script

3. **Add debug logging** (temporary):
   ```python
   logger.debug("Header update: order_names=%s", order_names)
   logger.debug("Header update: transformed_order_names=%s", transformed_order_names)
   logger.debug("Header update: mapping=%s", name_mapping)
   ```

**Expected Result**:
- Headers show transformed names: `"# === newpkg ==="` instead of `"# === oldpkg ==="`
- Test `test_mode_none_with_user_actions_original_scope` passes

### Solution 2: Fix Shim Scope Validation After Unify Mode

**Approach**: Ensure validation uses correct module names after unify mode transformations.

**Implementation**:

1. **Investigate unify mode output**:
   - Check what module names exist after unify mode
   - Add debug logging to see `shim_names` after unify mode
   - Verify that unify mode creates the expected module structure

2. **Fix validation**:
   - If unify mode creates different names, adjust validation to use those names
   - Or adjust the test to use the correct module name after unify
   - Consider making validation more flexible for shim scope actions

3. **Alternative**: If the test expectation is wrong:
   - Update test to use the correct module name after unify mode
   - Or update test to use `scope: "original"` if that's more appropriate

**Expected Result**:
- Validation succeeds with correct module names after unify mode
- Test `test_mode_unify_with_user_actions` passes

### Solution 3: Fix Delete Action Shim Removal

**Approach**: Ensure delete actions with `affects: "shims"` correctly remove shims.

**Implementation**:

1. **Verify delete action application**:
   - Check that `shims_only_actions` contains the delete action
   - Verify that `shims_only_actions` are applied to `shim_names` at the right point
   - Add debug logging to see `shim_names` before and after delete action

2. **Fix component matching**:
   - Verify that `source in module_name.split(".")` works correctly
   - Test: `"pkg1" in "mypkg.pkg1".split(".")` should be `True`
   - If not working, check if there's a bug in the matching logic

3. **Verify shim generation**:
   - Ensure shims aren't regenerated after delete action
   - Check that delete action is applied after all shim names are determined
   - Verify that shim code generation uses the modified `shim_names` list

**Expected Result**:
- Delete action removes shims: `"mypkg.pkg1"` not in output
- Files are still stitched (module code present)
- Test `test_affects_shims_only_affects_shim_generation_comprehensive` passes

## Implementation Strategy

### Recommended Order

1. **Start with Solution 3** (fix delete action shim removal) - Most straightforward, similar to iteration 12.6
2. **Add Solution 2** (fix shim scope validation) - May require understanding unify mode behavior
3. **Add Solution 1** (fix header update) - Most complex, may need debugging to understand why replacement isn't working

### Testing Strategy

After each solution:
1. Run the specific failing test to verify progress
2. Add debug logging to understand what's happening
3. Check actual output vs expected output
4. Run all module action integration tests to ensure no regressions
5. Run full test suite to ensure broader compatibility

### Verification Steps

For each test:

**Test 1** (`test_mode_none_with_user_actions_original_scope`):
1. Verify that `transformed_order_names` contains `["newpkg", "newpkg.module"]`
2. Verify that headers are updated: `"# === newpkg ==="` and `"# === newpkg.module ==="`
3. Check stitched file output for transformed module names

**Test 2** (`test_mode_unify_with_user_actions`):
1. Verify that unify mode creates expected module names
2. Verify that `shim_names` contains the module name the action expects
3. Check that validation succeeds with correct module names

**Test 3** (`test_affects_shims_only_affects_shim_generation_comprehensive`):
1. Verify that delete action is applied to `shim_names`
2. Verify that `"mypkg.pkg1"` is removed from `shim_names`
3. Check that shim setup code doesn't contain `"mypkg.pkg1"`
4. Verify that module code is still present (files still stitched)

## Context for Independent Problem Solving

### Key Files

- `src/serger/stitch.py:1908-1930` - Header update logic
- `src/serger/stitch.py:1992` - Shim scope action validation
- `src/serger/module_actions.py:519-554` - Delete action implementation
- `src/serger/stitch.py:1857-1861` - Action separation by affects value
- `src/serger/stitch.py:1944-1951` - Shim scope action application

### Key Concepts

- Headers are built from `order_names` in `collect_module_sources()`
- Actions are applied to `shim_names_raw` to get `transformed_names`
- Header update needs to map `order_names` → `transformed_order_names` and update headers
- Unify mode transforms packages into a single package structure
- Delete actions with `affects: "shims"` should remove shims but not filter files
- Component matching: `source in module_name.split(".")` should match `"pkg1"` in `"mypkg.pkg1"`

### Debugging Tips

1. **For header update**:
   ```python
   logger.debug("order_names: %s", order_names)
   logger.debug("transformed_order_names: %s", transformed_order_names)
   logger.debug("parts before update: %s", [p[:50] for p in parts])
   # ... update logic ...
   logger.debug("parts after update: %s", [p[:50] for p in parts])
   ```

2. **For unify mode validation**:
   ```python
   logger.debug("shim_names after unify: %s", shim_names)
   logger.debug("action source: %s", action.get("source"))
   logger.debug("available modules: %s", sorted(shim_names))
   ```

3. **For delete action**:
   ```python
   logger.debug("Delete action: source=%s, shim_names before: %s", source, shim_names)
   shim_names = apply_single_action(shim_names, action, detected_packages)
   logger.debug("shim_names after: %s", shim_names)
   ```

## Success Criteria

All 3 remaining tests must pass:
1. ✅ `test_mode_none_with_user_actions_original_scope` - Headers show transformed names
2. ✅ `test_mode_unify_with_user_actions` - Validation succeeds after unify mode
3. ✅ `test_affects_shims_only_affects_shim_generation_comprehensive` - Delete action removes shims

Additionally:
- ✅ All other tests continue to pass (no regressions)
- ✅ `poetry run poe check:fix` passes completely
- ✅ All 10 integration tests from iteration 14 now pass

## Commit Message

```
fix(stitch): fix remaining module action integration test failures

- Fix header update logic to correctly transform module section headers
- Fix shim scope validation after unify mode transformations
- Fix delete action shim removal with affects: "shims"

Fixes 3 remaining failing tests from iteration 14:
- test_mode_none_with_user_actions_original_scope
- test_mode_unify_with_user_actions
- test_affects_shims_only_affects_shim_generation_comprehensive

All 10 integration tests from iteration 14 now pass.
```

## Next Steps After Fixing

1. Run `poetry run poe check:fix` to verify all tests pass
2. Update `current_plan/START_HERE.md` to mark iteration 14.6 as completed
3. Document any edge cases discovered during fixing
4. Verify that all module action scenarios work correctly end-to-end
4. Mark iteration 14 as complete - all integration tests passing

