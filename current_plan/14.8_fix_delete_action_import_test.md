# Iteration 14.8: Fix Delete Action Import Test
> **Context**: See `current_plan/00_overview.md` for overall strategy and principles.
> **Prerequisites**: Iteration 14.7 must be completed first.

## Overview

Iteration 14.7 fixed the header update issue, leaving 1 remaining failing test. This iteration addresses the delete action import test failure.

## Failing Test Analysis

### Test: `test_end_to_end_delete_action_works`

**Location**: `tests/9_integration/test_module_actions_integration.py:640`

**Test Setup**:
- Files: `pkg1/__init__.py`, `pkg1/module.py` (with `def func()`)
- `package="mypkg"`
- Action: `{"source": "pkg1", "action": "delete", "scope": "original", "affects": "both"}`

**Expected Behavior**:
- Delete action with `affects: "both"` should:
  1. Filter files from stitching (no modules stitched)
  2. Remove shims from shim generation
  3. Make the module unavailable for import
- Test expects `ImportError` when trying to import `mypkg.pkg1.module`

**Actual Error**:
```
Failed: DID NOT RAISE <class 'ImportError'>
```

**Current Status**:
- Delete action is working for file filtering: "Successfully stitched 0 modules"
- Content checks pass: `"def func()"` not in content, `"pkg1"` not in content
- Import test fails: ImportError not raised when trying to import deleted module
- The import statement is: `from mypkg.pkg1.module import func`

**Root Cause**:
- The delete action successfully filters files from stitching
- The delete action successfully removes shims (no `"pkg1"` in output)
- But when trying to import the deleted module, no ImportError is raised
- This suggests the module might still be accessible through some other path, or the import mechanism isn't properly handling deleted modules

## Root Cause Analysis

### Issue: Import Not Raising ImportError for Deleted Module

**Location**: `tests/9_integration/test_module_actions_integration.py:690-691`

**Problem**:
- Delete action with `affects: "both"` should make the module completely unavailable
- The test loads the stitched module and tries to import from `mypkg.pkg1.module`
- Expected: `ImportError` should be raised
- Actual: No error is raised (import succeeds or silently fails)

**Possible Causes**:
1. **Shim system still creating module structure**: Even though shims are removed, the module structure might still exist in `sys.modules` or be accessible through some other mechanism
2. **Import path resolution**: The import might be resolving through a different path that wasn't deleted
3. **Module caching**: The module might be cached in `sys.modules` from a previous import
4. **Delete action not removing all references**: The delete action might not be removing all necessary references to make the module truly unavailable

**Investigation Needed**:
1. Check if shims are actually removed from the stitched file
2. Check if the module structure exists in the stitched file
3. Check if `sys.modules` contains any references to the deleted module
4. Verify that the import statement is actually trying to import from the deleted module
5. Check if there's a fallback import mechanism that's allowing the import to succeed

## Proposed Solutions

### Solution: Fix Import Test to Properly Test Deleted Module

**Approach**: Ensure the test properly verifies that a deleted module cannot be imported.

**Implementation Steps**:

1. **Verify shim removal**:
   - Check that no shims are generated for the deleted module
   - Verify that `"mypkg.pkg1"` and `"mypkg.pkg1.module"` are not in the stitched file

2. **Verify module structure removal**:
   - Check that the module code is not in the stitched file
   - Verify that no references to `pkg1` exist in the stitched file

3. **Fix import test**:
   - Ensure `sys.modules` is cleared before attempting import
   - Verify that the import statement is correct
   - Check if the import is actually being attempted (not skipped)
   - Consider using `importlib.import_module()` instead of `from ... import` to get better error handling

3. **Add better error handling**:
   - If ImportError is not raised, check what error (if any) is raised
   - Verify that the module is actually unavailable
   - Add debug logging to see what's happening during import

**Expected Result**:
- Import of deleted module raises `ImportError`
- Test `test_end_to_end_delete_action_works` passes

## Implementation Strategy

### Recommended Order

1. **Add debug logging** to understand what's happening during import
2. **Verify shim removal** - ensure no shims are generated for deleted module
3. **Fix import test** - ensure proper error handling and module clearing
4. **Test and verify** - ensure test passes and no regressions

### Testing Strategy

After each step:
1. Run the specific failing test to verify progress
2. Add debug logging to understand what's happening
3. Check actual output vs expected output
4. Run all module action integration tests to ensure no regressions
5. Run full test suite to ensure broader compatibility

### Verification Steps

**Test** (`test_end_to_end_delete_action_works`):
1. Verify that files are filtered: "Successfully stitched 0 modules"
2. Verify that content is removed: `"def func()"` not in content
3. Verify that shims are removed: `"pkg1"` not in content, `"mypkg.pkg1"` not in content
4. Verify that import fails: `ImportError` raised when trying to import `mypkg.pkg1.module`
5. Check stitched file output for any remaining references to `pkg1`

## Context for Independent Problem Solving

### Key Files

- `tests/9_integration/test_module_actions_integration.py:640-691` - Delete action test
- `src/serger/stitch.py:2088-2162` - Delete action application for shims
- `src/serger/stitch.py:2662-2700` - Delete action file filtering

### Key Concepts

- Delete actions with `affects: "both"` should remove modules from both stitching and shims
- Deleted modules should be completely unavailable for import
- `sys.modules` caching might interfere with import tests
- Import errors should be raised when trying to import deleted modules

### Debugging Tips

1. **For import test**:
   ```python
   # Clear sys.modules before import
   for name in list(sys.modules.keys()):
       if name.startswith(("pkg1", "mypkg", "test_e2e_delete")):
           del sys.modules[name]
   
   # Try import and check what happens
   try:
       from mypkg.pkg1.module import func
       print("ERROR: Import succeeded but should have failed!")
   except ImportError as e:
       print(f"SUCCESS: ImportError raised: {e}")
   except Exception as e:
       print(f"UNEXPECTED: Different error raised: {type(e).__name__}: {e}")
   ```

2. **For shim verification**:
   ```python
   content = out_file.read_text()
   assert "mypkg.pkg1" not in content
   assert "pkg1.module" not in content
   assert "_setup_pkg_modules" not in content or "pkg1" not in content
   ```

3. **For module structure verification**:
   ```python
   content = out_file.read_text()
   assert "def func()" not in content
   assert "pkg1" not in content.split()  # Check for any references
   ```

## Success Criteria

The remaining test must pass:
1. ✅ `test_end_to_end_delete_action_works` - ImportError raised when importing deleted module

Additionally:
- ✅ All other tests continue to pass (no regressions)
- ✅ `poetry run poe check:fix` passes completely

## Commit Message

```
fix(tests): fix delete action import test to properly verify module deletion

- Ensure sys.modules is properly cleared before import attempt
- Verify that deleted modules are completely unavailable
- Add proper error handling for import test
- Fix import statement to properly test deleted module

Fixes remaining failing test from iteration 14.7:
- test_end_to_end_delete_action_works
```

## Next Steps After Fixing

1. Run `poetry run poe check:fix` to verify all tests pass
2. Update `current_plan/START_HERE.md` to mark iteration 14.8 as completed
3. Document any edge cases discovered during fixing
4. Verify that all module action scenarios work correctly end-to-end
5. Mark iteration 14 as complete - all integration tests passing

