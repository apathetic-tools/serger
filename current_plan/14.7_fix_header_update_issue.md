# Iteration 14.7: Fix Header Update Issue
> **Context**: See `current_plan/00_overview.md` for overall strategy and principles.
> **Prerequisites**: Iteration 14.6 must be completed first.

## Overview

Iteration 14.6 fixed 2 out of 3 failing integration tests. This iteration addresses the remaining 1 test failure:
1. Header update not working for module section headers

## Failing Test Analysis

### Test: `test_mode_none_with_user_actions_original_scope`

**Location**: `tests/9_integration/test_module_actions_integration.py:872`

**Test Setup**:
- Files: `oldpkg/__init__.py`, `oldpkg/module.py`
- `package="mypkg"`, `module_mode="none"`
- User action: `{"source": "oldpkg", "dest": "newpkg", "scope": "original"}`

**Expected Behavior**:
- Action transforms `oldpkg` → `newpkg` in module names
- Module section headers should show `"# === newpkg ==="` and `"# === newpkg.module ==="`
- Output should contain `"mypkg.newpkg.module"` or `"newpkg.module"` (in shim code)
- Headers should be updated to show transformed names

**Actual Error**:
```
assert ('"mypkg.newpkg.module"' in ... or '"newpkg.module"' in ...)
Failed: Headers still show "# === oldpkg ===" and "# === oldpkg.module ==="
```

**Current Status**:
- The shim code transformation appears to be working (based on iteration 14.6 fixes)
- The header update code is in place at `src/serger/stitch.py:1915-1950`
- The replacement logic looks correct but isn't finding/replacing the headers
- Debug logging was added but no debug output appears, suggesting the replacement code path may not be executing

## Root Cause Analysis

### Issue: Header Update Logic Not Working

**Location**: `src/serger/stitch.py:1915-1950`

**Problem**:
- Headers are built in `_collect_modules()` using `module_name` from `derive_module_name()`
- Headers are created as `f"\n# === {module_name} ===\n{module_body.strip()}\n\n"` (line 1713)
- Actions are applied to `order_names` to get `transformed_order_names` (line 1912-1914)
- Header update tries to map `order_names[i]` → `transformed_order_names[i]` and update headers (lines 1926-1950)
- But the replacement isn't working - headers still show original names

**Possible Causes**:
1. `order_names` doesn't match the module names used in headers
   - Headers use `module_name` from `derive_module_name()` 
   - `order_names` comes from `derived_module_names` in `_collect_modules()`
   - These should match, but may differ due to package root handling
2. `transformed_order_names` doesn't contain the expected transformed names
   - `apply_module_actions()` may not be transforming correctly
   - Or the transformation may be happening but in a different format
3. Header pattern matching isn't finding the headers
   - Pattern: `f"# === {original_name} ==="`
   - Headers contain: `"\n# === {module_name} ===\n"`
   - The pattern should match, but may not due to whitespace or exact format differences
4. The replacement is happening but `parts` isn't being used when building final script
   - Final script uses `"\n".join(parts)` at line 2360
   - If `parts` is modified correctly, it should work
5. The replacement code path isn't being executed
   - Code is inside `if original_scope_actions:` block (line 1875)
   - If `original_scope_actions` is empty, replacement won't happen
   - But the test has `scope: "original"`, so it should be in `original_scope_actions`

**Investigation Needed**:
1. Verify that `order_names` matches the module names in headers
   - Check what `order_names` contains for the test case
   - Check what module names are used in headers
   - Verify they match exactly
2. Verify that `transformed_order_names` contains the correct transformed names
   - Check if `apply_module_actions()` is being called correctly
   - Check if the transformation produces `["newpkg", "newpkg.module"]`
3. Check if header pattern matching is working correctly
   - Add debug logging to see if pattern is found
   - Verify the exact format of headers in `parts`
   - Check if whitespace or formatting is causing mismatch
4. Verify that `parts` list is being modified correctly
   - Check if `parts[j] = part.replace(...)` is actually modifying the list
   - Verify that modified `parts` is used when building final script
5. Check if the replacement code path is being executed
   - Verify that `original_scope_actions` contains the action
   - Check if the `if transformed_name != original_name:` condition is met
   - Add debug logging to trace execution

## Proposed Solutions

### Solution: Fix Header Update Logic

**Approach**: Debug and fix the header replacement logic to ensure headers are updated correctly.

**Implementation Steps**:

1. **Add debug logging** to understand what's happening:
   ```python
   logger.debug("Header update: order_names=%s", order_names)
   logger.debug("Header update: transformed_order_names=%s", transformed_order_names)
   logger.debug("Header update: original_scope_actions=%s", original_scope_actions)
   for i, original_name in enumerate(order_names):
       if i < len(transformed_order_names):
           transformed_name = transformed_order_names[i]
           logger.debug("Mapping: %s -> %s", original_name, transformed_name)
           if transformed_name != original_name:
               header_pattern = f"# === {original_name} ==="
               logger.debug("Searching for pattern: %s", header_pattern)
               for j, part in enumerate(parts):
                   if header_pattern in part:
                       logger.debug("Found pattern in part %d", j)
                       parts[j] = part.replace(header_pattern, new_header)
                       logger.debug("Replaced: %s -> %s", header_pattern, new_header)
   ```

2. **Verify `order_names` matches headers**:
   - Check if `order_names` contains `["oldpkg", "oldpkg.module"]` for the test
   - Check if headers are created with these exact names
   - If they don't match, fix the mismatch

3. **Verify transformation is correct**:
   - Check if `apply_module_actions(["oldpkg", "oldpkg.module"], actions, packages)` returns `["newpkg", "newpkg.module"]`
   - If not, debug why the transformation isn't working

4. **Fix pattern matching if needed**:
   - If pattern isn't matching, check exact header format
   - May need to use regex or more flexible matching
   - Ensure whitespace/newlines are handled correctly

5. **Verify `parts` modification**:
   - Ensure `parts[j] = part.replace(...)` actually modifies the list
   - Check if Python's string immutability is causing issues (it shouldn't)
   - Verify modified `parts` is used in final script assembly

**Expected Result**:
- Headers show transformed names: `"# === newpkg ==="` and `"# === newpkg.module ==="`
- Test `test_mode_none_with_user_actions_original_scope` passes
- All 10 integration tests from iteration 14 now pass

## Implementation Strategy

### Recommended Order

1. **Add debug logging** to understand current behavior
2. **Verify `order_names` matches headers** - fix mismatch if found
3. **Verify transformation** - ensure `transformed_order_names` is correct
4. **Fix pattern matching** - ensure headers are found and replaced
5. **Test and verify** - ensure all tests pass

### Testing Strategy

After each step:
1. Run the specific failing test to verify progress
2. Check debug output to understand what's happening
3. Verify actual output vs expected output
4. Run all module action integration tests to ensure no regressions
5. Run full test suite to ensure broader compatibility

### Verification Steps

**Test** (`test_mode_none_with_user_actions_original_scope`):
1. Verify that `order_names` contains `["oldpkg", "oldpkg.module"]`
2. Verify that `transformed_order_names` contains `["newpkg", "newpkg.module"]`
3. Verify that headers are found and replaced: `"# === oldpkg ==="` → `"# === newpkg ==="`
4. Check stitched file output for transformed headers
5. Check stitched file output for transformed module names in shim code

## Context for Independent Problem Solving

### Key Files

- `src/serger/stitch.py:1915-1950` - Header update logic
- `src/serger/stitch.py:1712-1713` - Header creation in `_collect_modules()`
- `src/serger/stitch.py:2360` - Final script assembly using `parts`
- `src/serger/stitch.py:1875-1950` - Original scope action application and header update
- `src/serger/stitch.py:2777` - Where `order_names` is passed to `_build_final_script()`

### Key Concepts

- Headers are built from `module_name` in `_collect_modules()` (line 1712)
- `order_names` comes from `derived_module_names` in `_collect_modules()` (line 2777)
- These should match, but may differ due to package root handling
- Actions are applied to `order_names` to get `transformed_order_names`
- Header update maps `order_names[i]` → `transformed_order_names[i]` and replaces headers
- Final script uses `"\n".join(parts)` so modified `parts` should be used

### Debugging Tips

1. **For header update**:
   ```python
   logger.debug("order_names: %s", order_names)
   logger.debug("transformed_order_names: %s", transformed_order_names)
   logger.debug("parts before update: %s", [p[:50] for p in parts])
   # ... update logic ...
   logger.debug("parts after update: %s", [p[:50] for p in parts])
   ```

2. **For pattern matching**:
   ```python
   header_pattern = f"# === {original_name} ==="
   logger.debug("Searching for: %s", repr(header_pattern))
   for j, part in enumerate(parts):
       if header_pattern in part:
           logger.debug("Found in part %d: %s", j, repr(part[:100]))
   ```

3. **For transformation verification**:
   ```python
   logger.debug("Applying actions: %s to %s", original_scope_actions, order_names)
   transformed = apply_module_actions(list(order_names), original_scope_actions, detected_packages)
   logger.debug("Result: %s", transformed)
   ```

## Success Criteria

The remaining test must pass:
1. ✅ `test_mode_none_with_user_actions_original_scope` - Headers show transformed names

Additionally:
- ✅ All other tests continue to pass (no regressions)
- ✅ `poetry run poe check:fix` passes completely
- ✅ All 10 integration tests from iteration 14 now pass

## Commit Message

```
fix(stitch): fix header update logic for module section headers

- Fix header replacement to correctly transform module section headers
- Ensure order_names matches module names used in headers
- Verify transformed_order_names contains correct transformed names
- Fix pattern matching to find and replace headers correctly

Fixes remaining failing test from iteration 14:
- test_mode_none_with_user_actions_original_scope

All 10 integration tests from iteration 14 now pass.
```

## Next Steps After Fixing

1. Run `poetry run poe check:fix` to verify all tests pass
2. Update `current_plan/START_HERE.md` to mark iteration 14.7 as completed
3. Document any edge cases discovered during fixing
4. Verify that all module action scenarios work correctly end-to-end
5. Mark iteration 14 as complete - all integration tests passing

